# XTTS Streaming Server

Оптимизированный сервер для потоковой передачи синтезированной речи с использованием XTTS (Coqui-AI). Поддерживает клонирование голоса в режиме реального времени, кэширование голосов, пакетную обработку длинных текстов и многое другое.

## Особенности

- **Потоковая передача речи**: мгновенное начало синтеза с отправкой аудио по мере генерации
- **Клонирование голоса**: создание голосов из аудиофайлов с возможностью повторного использования
- **Хранение голосов**: сохранение клонированных голосов для последующего использования
- **Кэширование**: оптимизация производительности за счет кэширования голосов в памяти
- **Пакетная обработка**: эффективная обработка длинных текстов разбиением на фрагменты
- **Мониторинг**: отслеживание статуса генерации и управление сессиями
- **Многоязычность**: поддержка всех языков, доступных в XTTS

## Архитектура

Проект имеет модульную архитектуру:

```
xtts-server/
├── main.py              # Основной файл с FastAPI приложением
├── config.py            # Настройки и конфигурации
├── models/              # Модели данных
│   ├── __init__.py
│   ├── inputs.py        # Модели входных данных (Pydantic)
│   └── voice_storage.py # Класс для хранения голосов
├── services/            # Сервисы
│   ├── __init__.py
│   ├── audio.py         # Функции обработки аудио
│   ├── cache.py         # Кэширование голосов
│   ├── tts.py           # Основная логика TTS
│   └── utils.py         # Вспомогательные функции
├── api/                 # API слой
│   ├── __init__.py
│   ├── routes.py        # API маршруты
│   └── responses.py     # Обработка ответов
├── requirements.txt
└── run.py               # Скрипт запуска
```

## Установка

### Требования

- Python 3.8+
- CUDA-совместимая GPU (опционально, для ускорения)

### Настройка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/yourusername/xtts-streaming-server.git
cd xtts-streaming-server
```

2. Создайте и активируйте виртуальное окружение:
```bash
python -m venv .venv
source .venv/bin/activate  # На Windows: .venv\Scripts\activate
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Запуск сервера

Запустите сервер командой:
```bash
python run.py
```

Сервер будет доступен по адресу `http://localhost:8000`. Swagger документация доступна по этому же адресу.

## Настройка через переменные окружения

Сервер можно настроить с помощью переменных окружения:

- `PORT` - порт для запуска (по умолчанию 8000)
- `DEBUG` - режим отладки (по умолчанию False)
- `NUM_THREADS` - количество потоков CPU (по умолчанию количество ядер)
- `MAX_CONCURRENT_REQUESTS` - максимальное количество одновременных запросов (по умолчанию 10)
- `CUSTOM_MODEL_PATH` - путь к пользовательской модели XTTS
- `USE_CPU` - принудительное использование CPU даже при наличии GPU (по умолчанию False)
- `SPEAKER_CACHE_TTL` - время жизни кэша голосов в секундах (по умолчанию 3600)
- `SPEAKER_CACHE_MAX_SIZE` - максимальный размер кэша голосов (по умолчанию 100)
- `PRELOAD_VOICES` - список голосов для предварительной загрузки (через запятую)
- `VOICES_DIR` - директория для хранения сохраненных голосов (по умолчанию ./saved_voices)

## API документация

### Основные эндпоинты

- **POST /tts_stream** - Потоковый синтез речи
- **POST /tts** - Синтез полного аудио (не потоковый)
- **POST /clone_speaker** - Клонирование голоса из аудиофайла
- **POST /save_voice/{voice_id}** - Сохранение клонированного голоса
- **GET /saved_voices** - Получение списка сохраненных голосов
- **DELETE /saved_voices/{voice_id}** - Удаление сохраненного голоса
- **GET /cache/stats** - Статистика кэша голосов
- **POST /cache/clear** - Очистка кэша голосов
- **GET /stream_status/{session_id}** - Статус потоковой сессии
- **DELETE /stream_cancel/{session_id}** - Отмена потоковой сессии
- **GET /available_speakers** - Доступные встроенные голоса
- **GET /languages** - Доступные языки
- **GET /health** - Проверка статуса сервера

## Примеры использования

### Синтез речи с клонированным голосом

1. Клонирование голоса:
```bash
curl -X POST "http://localhost:8000/clone_speaker" \
  -F "wav_file=@path/to/voice-sample.wav" \
  -F 'options={"response_format": "save", "save_id": "my-voice", "name": "Мой голос", "description": "Описание голоса"}'
```

2. Синтез речи с сохраненным голосом:
```bash
curl -X POST "http://localhost:8000/tts_stream" \
  -H "Content-Type: application/json" \
  -d '{"text": "Текст для озвучивания", "language": "ru", "speaker_id": "my-voice"}'
```

### Получение статистики кэша

```bash
curl -X GET "http://localhost:8000/cache/stats"
```

### Проверка состояния сессии

```bash
curl -X GET "http://localhost:8000/stream_status/{session_id}"
```

## Оптимизации производительности

Сервер включает несколько оптимизаций для максимальной производительности:

1. **Кэширование голосов**: голоса сохраняются в памяти для быстрого доступа
2. **Предзагрузка голосов**: часто используемые голоса загружаются при запуске сервера
3. **Эффективное управление ресурсами**: семафоры для контроля доступа к модели
4. **Пакетная обработка**: разбиение длинных текстов на фрагменты для эффективной обработки
5. **Минимальная задержка**: немедленная отправка WAV-заголовка и тишины для установления соединения

## Решение проблем

### Ошибка размерностей тензоров

Если вы видите ошибку вида `Tensors must have same number of dimensions: got 2 and 3`, это означает, что есть проблема с размерностью тензоров голоса. Проверьте, что сохраненные голоса имеют правильную форму.

### Утечки памяти

Если вы наблюдаете утечки памяти, добавьте переменную окружения `SPEAKER_CACHE_TTL` с меньшим значением для более частой очистки кэша.

## Лицензия

Этот проект распространяется под лицензией MIT.